<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>勤務収入管理（Googleスプレッドシート送信）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, "Segoe UI", sans-serif;
      padding: 10px;
      background: #ffffff;
      color: #000000;
      font-size: 14px;
      max-width: 960px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 1.1rem;
      margin: 16px 0 6px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 14px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .form-group {
      flex: 1 1 140px;
      min-width: 140px;
    }
    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 2px;
    }
    select,
    input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    .readonly-box {
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f8f8f8;
      font-size: 0.9rem;
    }
    .time-select {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .time-select select {
      width: auto;
      min-width: 60px;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #888;
      padding: 6px 12px;
      font-size: 0.9rem;
      background: #f3f3f3;
      margin-right: 6px;
    }
    button:hover {
      background: #e6e6e6;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 0.85rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      vertical-align: top;
    }
    th {
      background: #f5f5f5;
    }
    td.right {
      text-align: right;
    }
    #status {
      margin-top: 6px;
      font-size: 0.85rem;
    }
    #status.ok {
      color: #008000;
    }
    #status.err {
      color: #d00000;
    }
    @media (max-width: 600px) {
      .form-row {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
<h1>勤務収入管理（Googleスプレッドシート送信）</h1>

<div class="card">
  <div class="form-row">
    <div class="form-group">
      <label>記入日時（自動）</label>
      <div id="nowDisplay" class="readonly-box"></div>
    </div>
    <div class="form-group">
      <label>出勤場所</label>
      <select id="place">
        <option value="">選択してください</option>
        <option value="ジャンボ総本店">ジャンボ総本店</option>
        <option value="スイミング">スイミング</option>
      </select>
    </div>
    <div class="form-group">
      <label>時給（円）</label>
      <input type="number" id="wage" min="0" step="1" />
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <label>出勤時刻</label>
      <div class="time-select">
        <select id="startHour"></select> :
        <select id="startMinute"></select>
      </div>
    </div>

    <div class="form-group">
      <label>退勤時刻</label>
      <div class="time-select">
        <select id="endHour"></select> :
        <select id="endMinute"></select>
      </div>
    </div>

    <div class="form-group">
      <label>勤務時間（h）</label>
      <div id="workHoursPreview" class="readonly-box"></div>
    </div>

    <div class="form-group">
      <label>収入（円）</label>
      <div id="incomePreview" class="readonly-box"></div>
    </div>
  </div>

  <button id="addBtn">行を追加して送信</button>
  <button id="clearBtn">この端末のデータ全削除</button>
  <div id="status"></div>
</div>

<div class="card">
<h2>明細一覧（端末保存分）</h2>
<table id="detailTable">
<thead>
<tr>
  <th>#</th><th>日時</th><th>日付</th><th>場所</th>
  <th>出勤</th><th>退勤</th><th>時間</th><th>時給</th><th>収入</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbyz3W185Vp1io-_DDTNt9aLiJbeWayfy2M4A6anRJdzGxO1Xv0Ose1GFoWSApoFL98ERA/exec";

const STORAGE_KEY = "shift_records_final";
let records = [];

function pad2(n){ return String(n).padStart(2,"0"); }

function nowStrings(){
  const d=new Date();
  return {
    date: d.toISOString().slice(0,10),
    timestamp:
      d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate())+
      " "+pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds())
  };
}

function initTimeSelect(){
  [startHour,endHour].forEach(s=>{
    s.innerHTML='<option value=""></option>';
    for(let i=0;i<24;i++) s.innerHTML+=`<option>${pad2(i)}</option>`;
  });
  [startMinute,endMinute].forEach(s=>{
    s.innerHTML='<option value=""></option>';
    ["00","15","30","45"].forEach(v=>s.innerHTML+=`<option>${v}</option>`);
  });
}

function getTime(h,m){ return h&&m?`${h}:${m}`:""; }
function toMin(t){ if(!t)return null; const[a,b]=t.split(":"); return a*60+(+b); }

function recalc(){
  const s=getTime(startHour.value,startMinute.value);
  const e=getTime(endHour.value,endMinute.value);
  const w=Number(wage.value);
  const sm=toMin(s), em=toMin(e);
  if(sm==null||em==null) return;
  let diff = em-sm;
  if(diff<=0) diff+=1440;
  const h=(diff/60).toFixed(2);
  workHoursPreview.textContent=h;
  incomePreview.textContent=w?Math.round(h*w):"";
}

function render(){
  const tb=document.querySelector("#detailTable tbody");
  tb.innerHTML="";
  records.forEach((r,i)=>{
    tb.innerHTML+=`
      <tr>
        <td>${i+1}</td><td>${r.timestamp}</td><td>${r.date}</td>
        <td>${r.place}</td><td>${r.startTime}</td><td>${r.endTime}</td>
        <td>${r.workHours}</td><td>${r.wage}</td><td>${r.income}</td>
      </tr>`;
  });
}

async function sendToSheet(rec){
  await fetch(SCRIPT_URL,{
    method:"POST",
    mode:"no-cors",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(rec)
  });
}

addBtn.onclick=async()=>{
  const n=nowStrings();
  const s=getTime(startHour.value,startMinute.value);
  const e=getTime(endHour.value,endMinute.value);
  if(!place.value||!s||!e||!wage.value){alert("未入力があります");return;}

  const rec={
    timestamp:n.timestamp,
    date:n.date,
    place:place.value,
    startTime:s,
    endTime:e,
    workHours:Number(workHoursPreview.textContent),
    hourlyWage:Number(wage.value),
    income:Math.round(workHoursPreview.textContent*wage.value)
  };

  records.push({...rec,wage:rec.hourlyWage});
  localStorage.setItem(STORAGE_KEY,JSON.stringify(records));
  render();

  await sendToSheet(rec);
  status.textContent="送信しました";
};

clearBtn.onclick=()=>{
  if(confirm("ローカルデータを全削除しますか？")){
    records=[];
    localStorage.removeItem(STORAGE_KEY);
    render();
  }
};

[startHour,startMinute,endHour,endMinute,wage].forEach(e=>e.onchange=recalc);

initTimeSelect();
nowDisplay.textContent=nowStrings().timestamp;
setInterval(()=>nowDisplay.textContent=nowStrings().timestamp,1000);
records=JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
render();
</script>
</body>
</html>
