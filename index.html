<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>勤務収入管理アプリ</title>

  <!-- PWA 用 -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ffffff" />

  <!-- SheetJS (Excel ライブラリ) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, "Segoe UI", sans-serif;
      padding: 10px;
      background: #ffffff;
      color: #000000;
      font-size: 14px;
      max-width: 960px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 1.1rem;
      margin: 16px 0 6px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 14px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .form-group {
      flex: 1 1 140px;
      min-width: 140px;
    }
    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 2px;
    }
    select,
    input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    .readonly-box {
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f8f8f8;
      font-size: 0.9rem;
    }
    .time-select {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .time-select select {
      width: auto;
      min-width: 60px;
    }
    .time-select span {
      padding: 0 2px;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #888;
      padding: 6px 12px;
      font-size: 0.9rem;
      background: #f3f3f3;
      margin-right: 6px;
    }
    button:hover {
      background: #e6e6e6;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 0.85rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      vertical-align: top;
    }
    th {
      background: #f5f5f5;
    }
    td.right {
      text-align: right;
    }
    @media (max-width: 600px) {
      .form-row {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <h1>勤務収入管理アプリ</h1>

  <div class="card">
    <div class="form-row">
      <div class="form-group">
        <label>記入日時（自動）</label>
        <div id="nowDisplay" class="readonly-box"></div>
      </div>
      <div class="form-group">
        <label for="place">出勤場所</label>
        <select id="place">
          <option value="">選択してください</option>
          <option value="ジャンボ総本店">ジャンボ総本店</option>
          <option value="スイミング">スイミング</option>
        </select>
      </div>
      <div class="form-group">
        <label for="wage">時給（円）</label>
        <input type="number" id="wage" min="0" step="1" />
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>出勤時刻</label>
        <div class="time-select">
          <select id="startHour"></select>
          <span>:</span>
          <select id="startMinute"></select>
        </div>
      </div>

      <div class="form-group">
        <label>退勤時刻</label>
        <div class="time-select">
          <select id="endHour"></select>
          <span>:</span>
          <select id="endMinute"></select>
        </div>
      </div>

      <div class="form-group">
        <label>勤務時間（時間・自動）</label>
        <div id="workHoursPreview" class="readonly-box"></div>
      </div>
      <div class="form-group">
        <label>今回収入（円・自動）</label>
        <div id="incomePreview" class="readonly-box"></div>
      </div>
    </div>

    <div>
      <button id="addBtn" type="button">行を追加</button>
      <button id="clearBtn" type="button">すべて削除</button>
      <button id="excelBtn" type="button">Excel保存</button>
    </div>
  </div>

  <div class="card">
    <h2>明細一覧</h2>
    <table id="detailTable">
      <thead>
        <tr>
          <th>#</th>
          <th>記入日時</th>
          <th>日付</th>
          <th>出勤場所</th>
          <th>出勤時刻</th>
          <th>退勤時刻</th>
          <th>勤務時間 (h)</th>
          <th>時給</th>
          <th>収入 (円)</th>
          <th>削除</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const STORAGE_KEY = "shiftIncomeRecords_v2";
    let records = [];

    function pad2(n) { return n.toString().padStart(2,"0"); }

    function getNowStrings() {
      const now = new Date();
      const y = now.getFullYear();
      const m = pad2(now.getMonth()+1);
      const d = pad2(now.getDate());
      const hh = pad2(now.getHours());
      const mm = pad2(now.getMinutes());
      const ss = pad2(now.getSeconds());
      return {
        date: `${y}-${m}-${d}`,
        timestamp: `${y}-${m}-${d} ${hh}:${mm}:${ss}`
      };
    }

    function updateNowDisplay() {
      document.getElementById("nowDisplay").textContent = getNowStrings().timestamp;
    }

    function initTimeSelects() {
      const sh = document.getElementById("startHour");
      const eh = document.getElementById("endHour");
      const sm = document.getElementById("startMinute");
      const em = document.getElementById("endMinute");

      const emptyH1 = new Option("--","");
      const emptyH2 = new Option("--","");
      sh.add(emptyH1); eh.add(emptyH2);
      for (let h=0; h<24; h++) {
        const v = pad2(h);
        sh.add(new Option(v,v));
        eh.add(new Option(v,v));
      }

      const emptyM1 = new Option("--","");
      const emptyM2 = new Option("--","");
      sm.add(emptyM1); em.add(emptyM2);
      ["00","15","30","45"].forEach(v=>{
        sm.add(new Option(v,v));
        em.add(new Option(v,v));
      });
    }

    function getTimeFromSelect(prefix){
      const h = document.getElementById(prefix+"Hour").value;
      const m = document.getElementById(prefix+"Minute").value;
      if(!h || !m) return "";
      return `${h}:${m}`;
    }

    function parseTimeToMinutes(t){
      if(!t) return null;
      const [h,m] = t.split(":").map(Number);
      if(isNaN(h)||isNaN(m)) return null;
      return h*60+m;
    }

    function calcWorkHoursDecimal(start,end){
      const s = parseTimeToMinutes(start);
      const e = parseTimeToMinutes(end);
      if(s===null||e===null) return null;
      let diff = e-s;
      if(diff<=0) diff += 24*60;
      return Math.round(diff/60*100)/100;
    }

    function updatePreviews(){
      const start = getTimeFromSelect("start");
      const end   = getTimeFromSelect("end");
      const wage  = Number(document.getElementById("wage").value);
      const hours = calcWorkHoursDecimal(start,end);
      const hBox = document.getElementById("workHoursPreview");
      const iBox = document.getElementById("incomePreview");
      if(hours===null){
        hBox.textContent=""; iBox.textContent=""; return;
      }
      hBox.textContent = hours.toFixed(2);
      if(!isNaN(wage)&&wage>0){
        iBox.textContent = Math.round(hours*wage).toLocaleString();
      }else{
        iBox.textContent="";
      }
    }

    function saveRecords(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    function loadRecords(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        try { records = JSON.parse(raw); }
        catch(e){ records = []; }
      }
      renderDetailTable();
    }

    function renderDetailTable(){
      const tbody=document.querySelector("#detailTable tbody");
      tbody.innerHTML="";
      records.forEach((r,idx)=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td class="right">${idx+1}</td>
          <td>${r.timestamp}</td>
          <td>${r.date}</td>
          <td>${r.place}</td>
          <td>${r.startTime}</td>
          <td>${r.endTime}</td>
          <td class="right">${r.workHours.toFixed(2)}</td>
          <td class="right">${r.wage}</td>
          <td class="right">${r.income.toLocaleString()}</td>
          <td><button type="button" data-index="${idx}" class="delRowBtn">削除</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function buildDailySummary(){
      const map={};
      records.forEach(r=>{
        if(!map[r.date]) map[r.date]={};
        if(!map[r.date][r.place]) map[r.date][r.place]={hours:0,income:0};
        map[r.date][r.place].hours+=r.workHours;
        map[r.date][r.place].income+=r.income;
      });
      const rows=[];
      Object.keys(map).sort().forEach(date=>{
        Object.keys(map[date]).forEach(place=>{
          const s=map[date][place];
          rows.push({
            日付:date,
            出勤場所:place,
            勤務時間合計h:Number(s.hours.toFixed(2)),
            収入合計円:Math.round(s.income)
          });
        });
      });
      return rows;
    }

    function exportToExcel(){
      if(records.length===0){
        alert("明細が1件もありません。まず行を追加してください。");
        return;
      }

      const all = records.map((r,idx)=>({
        No:idx+1,
        記入日時:r.timestamp,
        日付:r.date,
        出勤場所:r.place,
        出勤時刻:r.startTime,
        退勤時刻:r.endTime,
        勤務時間h:Number(r.workHours.toFixed(2)),
        時給円:r.wage,
        収入円:r.income
      }));

      const wb = XLSX.utils.book_new();
      const wsAll = XLSX.utils.json_to_sheet(all);
      XLSX.utils.book_append_sheet(wb, wsAll, "明細一覧");

      const jumbo = all.filter(r=>r.出勤場所==="ジャンボ総本店");
      const wsJ  = XLSX.utils.json_to_sheet(jumbo);
      XLSX.utils.book_append_sheet(wb, wsJ, "ジャンボ総本店");

      const swim = all.filter(r=>r.出勤場所==="スイミング");
      const wsS  = XLSX.utils.json_to_sheet(swim);
      XLSX.utils.book_append_sheet(wb, wsS, "スイミング");

      const summary = buildDailySummary();
      const wsSum = XLSX.utils.json_to_sheet(summary);
      XLSX.utils.book_append_sheet(wb, wsSum, "日別集計");

      const now=new Date();
      const fileName=`勤務記録_${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}.xlsx`;

      const wbout = XLSX.write(wb,{bookType:"xlsx",type:"array"});
      const blob  = new Blob([wbout],{type:"application/octet-stream"});
      const url   = URL.createObjectURL(blob);
      const a     = document.createElement("a");
      a.href=url;
      a.download=fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(()=>URL.revokeObjectURL(url),1000);
    }

    function setupEvents(){
      ["startHour","startMinute","endHour","endMinute","wage"].forEach(id=>{
        document.getElementById(id).addEventListener("change",updatePreviews);
        if(id==="wage") document.getElementById(id).addEventListener("input",updatePreviews);
      });

      document.getElementById("addBtn").addEventListener("click",()=>{
        const now=getNowStrings();
        const place=document.getElementById("place").value;
        const wage=Number(document.getElementById("wage").value);
        const start=getTimeFromSelect("start");
        const end  =getTimeFromSelect("end");
        if(!place){alert("出勤場所を選択してください。");return;}
        if(!wage||isNaN(wage)||wage<=0){alert("時給を正しく入力してください。");return;}
        if(!start||!end){alert("出勤時刻と退勤時刻を選択してください。");return;}

        const hours=calcWorkHoursDecimal(start,end);
        if(hours===null){alert("勤務時間を計算できません。");return;}
        const income=Math.round(hours*wage);

        records.push({
          timestamp:now.timestamp,
          date:now.date,
          place,
          startTime:start,
          endTime:end,
          wage,
          workHours:hours,
          income
        });
        saveRecords();
        renderDetailTable();

        document.getElementById("startHour").value="";
        document.getElementById("startMinute").value="";
        document.getElementById("endHour").value="";
        document.getElementById("endMinute").value="";
        document.getElementById("workHoursPreview").textContent="";
        document.getElementById("incomePreview").textContent="";
        updateNowDisplay();
      });

      document.getElementById("clearBtn").addEventListener("click",()=>{
        if(confirm("すべての明細を削除しますか？")){
          records=[];
          saveRecords();
          renderDetailTable();
        }
      });

      document.getElementById("excelBtn").addEventListener("click",exportToExcel);

      document.querySelector("#detailTable tbody").addEventListener("click",e=>{
        if(e.target.classList.contains("delRowBtn")){
          const idx=Number(e.target.getAttribute("data-index"));
          if(!isNaN(idx)){
            records.splice(idx,1);
            saveRecords();
            renderDetailTable();
          }
        }
      });
    }

    // PWA: service worker 登録
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(()=>{});
    }

    initTimeSelects();
    updateNowDisplay();
    setInterval(updateNowDisplay,1000);
    setupEvents();
    loadRecords();
  </script>
</body>
</html>
